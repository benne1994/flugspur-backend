<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Skipisten & Standort auf Hybridkarte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin: 0; overflow: hidden; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #loc-btn {
      position: absolute; z-index: 10; left: 10px; top: 10px; padding: 8px 12px;
      background: #fff; border-radius: 8px; border: none; cursor: pointer; font-size: 1em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
  </style>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
</head>
<body>
<button id="loc-btn">üìç Standort zeigen</button>
<div id="map"></div>
<script>
  const maptilerApiKey = 'r9nsDaWjLXRLFpq2ZVcC';

  const map = new maplibregl.Map({
    container: 'map',
    style: `https://api.maptiler.com/maps/hybrid/style.json?key=${maptilerApiKey}`,
    center: [10.25, 50.125],
    zoom: 11,
    pitch: 60,
    bearing: 0,
    maxPitch: 85,
    antialias: true
  });

  let clickedOnMarker = false;

  map.on('load', () => {
    map.addSource('terrain', {
      type: 'raster-dem',
      tiles: [`https://api.maptiler.com/tiles/terrain-rgb/{z}/{x}/{y}.png?key=${maptilerApiKey}`],
      tileSize: 512,
      maxzoom: 15
    });
    map.setTerrain({ source: 'terrain', exaggeration: 1.5 });

    map.addSource('pisten', {
      type: 'raster',
      tiles: ['https://tiles.opensnowmap.org/pistes/{z}/{x}/{y}.png'],
      tileSize: 256,
      attribution: '¬© OpenSnowMap'
    });
    map.addLayer({
      id: 'pisten-layer',
      type: 'raster',
      source: 'pisten',
      minzoom: 0,
      maxzoom: 17
    });
  });

  const btn = document.getElementById('loc-btn');
  let userMarker;
  btn.onclick = function() {
    if (!navigator.geolocation) {
      alert("Geolokalisierung wird nicht unterst√ºtzt.");
      return;
    }
    btn.textContent = "‚è≥ Standort wird gesucht...";
    navigator.geolocation.getCurrentPosition(pos => {
      const { longitude, latitude } = pos.coords;
      map.flyTo({ center: [longitude, latitude], zoom: 14, speed: 1.2 });
      if (userMarker) userMarker.setLngLat([longitude, latitude]);
      else userMarker = new maplibregl.Marker({ color: '#1976d2' })
        .setLngLat([longitude, latitude])
        .addTo(map);
      btn.textContent = "üìç Standort zeigen";
    }, () => {
      btn.textContent = "üìç Standort zeigen";
      alert("Standort nicht verf√ºgbar.");
    });
  };

  map.on('click', async (e) => {
    if (clickedOnMarker) {
      clickedOnMarker = false;
      return;
    }

    const { lng, lat } = e.lngLat;
    const zoom = map.getZoom();
    const tileSize = 256;
    const z = Math.min(15, Math.floor(zoom));
    const xtile = Math.floor((lng + 180) / 360 * Math.pow(2, z));
    const ytile = Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, z));

    const url = `https://api.maptiler.com/tiles/terrain-rgb/${z}/${xtile}/${ytile}.png?key=${maptilerApiKey}`;

    try {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.src = url;
      await img.decode();

      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = tileSize;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);

      const px = Math.floor(((lng + 180) / 360 * Math.pow(2, z) - xtile) * tileSize);
      const py = Math.floor(((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, z) - ytile) * tileSize);
      const [r, g, b] = ctx.getImageData(px, py, 1, 1).data;
      const elevation = -10000 + ((r * 256 * 256 + g * 256 + b) * 0.1);

      const marker = new maplibregl.Marker({ color: '#d32f2f' })
        .setLngLat([lng, lat])
        .setPopup(new maplibregl.Popup().setText(`H√∂he: ${elevation.toFixed(1)} m`))
        .addTo(map);

      marker.togglePopup();

      marker.getElement().addEventListener('click', (event) => {
        event.stopPropagation();
        clickedOnMarker = true;
        marker.remove();
      });

    } catch (err) {
      console.error('Fehler beim Abrufen der H√∂henmeter:', err);
    }
  });
</script>
</body>
</html>